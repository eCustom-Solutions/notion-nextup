name: Deploy to EC2 on main

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: admin
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: NODE_AUTH_TOKEN
          script: |
            set -Eeuo pipefail
            sudo -u appuser bash -lc '
              cd /opt/myapp/notion-nextup &&
              git fetch origin &&
              git reset --hard origin/main &&
              NODE_AUTH_TOKEN="$NODE_AUTH_TOKEN" npm ci --silent &&
              unset NODE_AUTH_TOKEN &&
              npm run --silent build &&
              pm2 reload notion-webhook --update-env &&
              for i in {1..15}; do
                if curl -sSf http://127.0.0.1:4401/healthz | grep -qx ok && \
                   curl -sSf http://127.0.0.1:4401/health | grep -q "\"ok\":true"; then
                  echo "health ok"; exit 0; fi
                echo "health retry $i"; sleep 2;
              done;
              echo "health check failed"; exit 1
            '


