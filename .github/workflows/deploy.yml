name: Deploy to EC2 on main

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: admin
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: NODE_AUTH_TOKEN
          script: |
            set -Eeuo pipefail
            sudo -u appuser bash -lc '
              PS4="+ [\$(date \"+%Y-%m-%dT%H:%M:%S%z\")] "
              diagnostics() {
                echo "::error::Deploy failed. Running diagnostics..."
                echo "::group::Deploy: diagnostics"
                echo "::notice::pm2 status"; pm2 status || true
                echo "::notice::pm2 describe"; pm2 describe notion-webhook || true
                echo "::notice::pm2 logs (last 200)"; pm2 logs notion-webhook --lines 200 || true
                echo "::notice::listening ports"; ss -lntp | grep 4401 || true
                echo "::notice::curl /healthz"; curl -v http://127.0.0.1:4401/healthz || true
                echo "::notice::curl /health"; curl -v http://127.0.0.1:4401/health || true
                echo "::notice::node/npm versions"; node -v || true; npm -v || true
                echo "::notice::git sha"; git rev-parse HEAD || true
                echo "::endgroup::"
              }
              trap diagnostics ERR
              set -x
              echo "::group::Deploy: git sync"
              cd /opt/myapp/notion-nextup &&
              git fetch origin &&
              git reset --hard origin/main &&
              echo "::endgroup::"
              echo "::group::Deploy: npm ci"
              NODE_AUTH_TOKEN="$NODE_AUTH_TOKEN" npm ci --loglevel=info &&
              unset NODE_AUTH_TOKEN &&
              echo "::endgroup::"
              echo "::group::Deploy: sanity (deps)"
              cd /opt/myapp/notion-nextup
              ls -la node_modules/dotenv || true
              node -e "console.log('\''dotenv resolves to'\'', require.resolve('\''dotenv'\''))" || true
              echo "::endgroup::"
              echo "::group::Deploy: build"
              npm run build &&
              echo "::endgroup::"
              echo "::group::Deploy: pm2 (ensure cwd)"
              pm2_exists=true
              pm2 describe notion-webhook >/dev/null 2>&1 || pm2_exists=false
              pm_cwd=""
              if [ "$pm2_exists" = "true" ]; then
                pm_cwd=$(pm2 describe notion-webhook 2>/dev/null | sed -n "s/^ *pm_cwd[[:space:]]*:[[:space:]]*//p" | head -n 1)
              fi
              if [ "$pm2_exists" = "false" ]; then
                echo "pm2 process missing; starting with explicit cwd"
                pm2 delete notion-webhook >/dev/null 2>&1 || true
                pm2 start /opt/myapp/notion-nextup/dist/webhook/http/prod-server.js --name notion-webhook --cwd /opt/myapp/notion-nextup
              elif [ "$pm_cwd" != "/opt/myapp/notion-nextup" ]; then
                echo "pm2 cwd mismatch: ${pm_cwd:-<empty>} -> /opt/myapp/notion-nextup; recreating process"
                pm2 delete notion-webhook >/dev/null 2>&1 || true
                pm2 start /opt/myapp/notion-nextup/dist/webhook/http/prod-server.js --name notion-webhook --cwd /opt/myapp/notion-nextup
              else
                echo "pm2 cwd ok: $pm_cwd; reloading"
                pm2 reload notion-webhook --update-env
              fi
              echo "::endgroup::"
              echo "::group::Deploy: health checks"
              for i in {1..15}; do
                healthz_body=$(curl -sS http://127.0.0.1:4401/healthz || true)
                health_body=$(curl -sS http://127.0.0.1:4401/health || true)
                echo "healthz response: ${healthz_body}"
                echo "health response: ${health_body}"
                if echo "$healthz_body" | grep -qx ok && \
                   echo "$health_body" | grep -q "\"ok\":true"; then
                  echo "health ok"; echo "::endgroup::"; exit 0; fi
                echo "health retry $i"; sleep 2;
              done;
              echo "health check failed"
              echo "::endgroup::"
              echo "::error::Health checks failed. Running diagnostics..."
              echo "::group::Deploy: diagnostics"
              echo "::notice::pm2 status"; pm2 status || true
              echo "::notice::pm2 describe"; pm2 describe notion-webhook || true
              echo "::notice::pm2 logs (last 200)"; pm2 logs notion-webhook --lines 200 || true
              echo "::notice::listening ports"; ss -lntp | grep 4401 || true
              echo "::notice::curl /healthz"; curl -v http://127.0.0.1:4401/healthz || true
              echo "::notice::curl /health"; curl -v http://127.0.0.1:4401/health || true
              echo "::notice::node/npm versions"; node -v || true; npm -v || true
              echo "::notice::git sha"; git rev-parse HEAD || true
              echo "::endgroup::"
              exit 1
            '


