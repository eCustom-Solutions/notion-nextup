## Status Report — 2025-10-24

### Context and Goals
- Migrate Notion estimates from days to hours while the system remains live.
- Stage the migration safely using new Notion properties and feature flags.
- Preserve projection accuracy (intraday precision) and avoid data loss.

### Problems We Set Out To Solve
- Replace reliance on `Estimated Days` with `Estimated Hours` without breaking existing logic.
- Convert existing values and keep projections correct across workday boundaries/weekends.
- Allow staged rollout (start with one user) and easy rollback.
- Untangle comment-logger integration that caused deploy crashes on EC2.

### What We Implemented
- Staging properties in Notion:
  - `Estimated Hours (Staging)` and `Estimated Hours Remaining (Staging)`.
- Config-driven toggle and names in `src/webhook/config.ts`:
  - `PREFER_ESTIMATED_HOURS_STAGING`, `ESTIMATED_HOURS_PROP`, `ESTIMATED_HOURS_REMAINING_PROP`, and legacy `ESTIMATED_DAYS_PROP`.
- Adapter (read path) prefers hours-first:
  - If hours present: convert hours → days using work window; else fallback to legacy days.
  - Keeps the rest of the system using a unified “days” estimate internally.
- Projection engine:
  - Intraday mode converts days → hours via `daysToHours` and uses `addBusinessHours` to compute dates with work window/weekend handling.
  - Business-days mode keeps whole-day accumulation.
  - QA inheritance preserved; zero-estimate first-task special case preserved.
- Scripts (for safe, stepwise migration):
  - Copy live days → hours staging (no conversion): `npm run estimated-hours:copy-demo -- --user "<Name>"`.
  - Convert staging in place (days→hours): `npm run estimated-hours:convert-estimate-to-hours -- --user "<Name>"`.
- CLI updated to async ranking and dry-run preview table.

### Current State
- Branch: `feat/estimated-hours` (local and remote).
- Hours-first read path enabled by config; falls back to days when hours absent.
- Demo user (e.g., Derious Vaughn) copied live days to staging and converted to hours successfully.
- Dry-run projections validated locally; logging path adjusted for macOS (`LOG_FILE=./app.log`).
- EC2 webhook is live with comment-logger mount disabled in the deployed `dist` (runtime-only hotfix) to avoid missing module.
- Authored `docs/guides/comment-logger-overview.md` to support separating the comment logger into a new repo.

### Known Quirks / Open Questions
- Projection anchoring rules:
  - Later tasks anchor to `max(previous completion, Task Started Date, now)` in intraday mode; business-day mode accumulates days from `startDate`.
  - First task with zero/blank estimate is forced to today (next business day if weekend).
  - Consider if we should always chain from previous completion unless `Task Started Date` is later.
- Migration next steps:
  - Expand allowlist or enable hours-first globally after more validation.
  - Plan deprecation window for legacy day fields.

### Safe-Rollout Checklist
- Keep `PREFER_ESTIMATED_HOURS_STAGING=true` scoped to demo users first.
- Run copy-only and convert-in-place scripts in dry-run, then live.
- Validate CLI dry-run output and spot-check Notion records.
- Expand allowlist incrementally; monitor webhook logs.

### Quick Commands
- Copy days → staging (no conversion):
  - `npm run estimated-hours:copy-demo -- --user "Derious Vaughn"`
- Convert staging days → hours in place:
  - `npm run estimated-hours:convert-estimate-to-hours -- --user "Derious Vaughn"`
- CLI dry-run (with local log):
  - `LOG_FILE=./app.log ts-node src/cli/notion-nextup.ts --dry-run --user "Derious Vaughn"`


